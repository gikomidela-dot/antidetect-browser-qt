name: Build Windows Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.5.3'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        modules: 'qtwebengine qtwebchannel qtpositioning'
        cache: false
    
    - name: Install OpenSSL
      run: |
        choco install openssl -y
        
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.26.x'
    
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="${env:Qt6_DIR}" `
          -DOPENSSL_ROOT_DIR="C:/Program Files/OpenSSL-Win64" `
          -DOPENSSL_INCLUDE_DIR="C:/Program Files/OpenSSL-Win64/include" `
          -DOPENSSL_CRYPTO_LIBRARY="C:/Program Files/OpenSSL-Win64/lib/VC/x64/MD/libcrypto.lib" `
          -DOPENSSL_SSL_LIBRARY="C:/Program Files/OpenSSL-Win64/lib/VC/x64/MD/libssl.lib"
    
    - name: Build
      run: |
        cd build
        cmake --build . --config Release -j4
    
    - name: Deploy Qt dependencies
      run: |
        cd build/Release
        $windeployqt = Join-Path $env:Qt6_DIR "bin/windeployqt.exe"
        & $windeployqt --release --webenginewidgets AntidetectBrowser.exe
    
    - name: Copy OpenSSL DLLs
      run: |
        cd build/Release
        Copy-Item "C:/Program Files/OpenSSL-Win64/bin/libssl-3-x64.dll" . -ErrorAction SilentlyContinue
        Copy-Item "C:/Program Files/OpenSSL-Win64/bin/libcrypto-3-x64.dll" . -ErrorAction SilentlyContinue
    
    - name: Create portable package
      run: |
        cd build
        $DeployDir = "AntidetectBrowser-Windows-x64"
        New-Item -ItemType Directory -Path $DeployDir -Force
        
        # Copy all files from Release folder
        Copy-Item -Recurse -Force Release/* -Destination $DeployDir -ErrorAction SilentlyContinue
        
        # Create README
        @"
        Antidetect Browser - Windows x64
        =================================
        
        Double-click AntidetectBrowser.exe to run
        
        Features:
        - Browser fingerprint spoofing
        - Proxy support (HTTP/HTTPS/SOCKS4/SOCKS5)
        - VPN integration (OpenVPN, WireGuard, AmneziaWG)
        - Cookie import/export
        - TLS fingerprinting
        - Timezone spoofing
        
        Version: ${{ github.sha }}
        Built: $(Get-Date -Format "yyyy-MM-dd HH:mm")
        "@ | Out-File -FilePath "$DeployDir/README.txt"
        
        # Create ZIP
        Compress-Archive -Path $DeployDir -DestinationPath "AntidetectBrowser-Windows-x64.zip"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: AntidetectBrowser-Windows-x64
        path: build/AntidetectBrowser-Windows-x64.zip
        retention-days: 30
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: build/AntidetectBrowser-Windows-x64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
